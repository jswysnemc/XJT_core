<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.ljp.xjt.mapper.TeacherMapper">

    <!-- 通用查询映射结果 -->
    <resultMap id="BaseResultMap" type="com.ljp.xjt.entity.Teacher">
        <id column="id" property="id" />
        <result column="user_id" property="userId" />
        <result column="teacher_number" property="teacherNumber" />
        <result column="teacher_name" property="teacherName" />
        <result column="gender" property="gender" />
        <result column="title" property="title" />
        <result column="department_id" property="departmentId" />
        <result column="created_time" property="createdTime" />
        <result column="updated_time" property="updatedTime" />
    </resultMap>

    <!-- 分页查询教师列表 -->
    <select id="selectTeacherList" resultMap="BaseResultMap">
        SELECT * FROM teachers
        <where>
            <if test="teacherName != null and teacherName != ''">
                AND teacher_name LIKE CONCAT('%', #{teacherName}, '%')
            </if>
            <if test="departmentId != null">
                AND department_id = #{departmentId}
            </if>
        </where>
        ORDER BY created_time DESC
    </select>

    <!-- 根据用户ID查询教师信息 -->
    <select id="selectByUserId" resultMap="BaseResultMap">
        SELECT * FROM teachers WHERE user_id = #{userId} LIMIT 1
    </select>

    <!-- 检查教工号是否存在 -->
    <select id="checkTeacherNumberExists" resultType="java.lang.Integer">
        SELECT COUNT(*) FROM teachers WHERE teacher_number = #{teacherNumber}
    </select>

    <!-- 根据用户ID查询该教师所教授的课程列表 -->
    <select id="findCoursesByUserId" resultType="com.ljp.xjt.dto.TeacherCourseDto">
        SELECT DISTINCT
            c.id AS courseId,
            c.course_name AS courseName,
            c.credits
        FROM courses c
        JOIN teaching_assignments ta ON c.id = ta.course_id
        JOIN teachers t ON ta.teacher_id = t.id
        WHERE t.user_id = #{userId}
    </select>

    <!-- 根据用户ID和课程ID，查询该教师在该课程下所教授的班级列表 -->
    <select id="findClassesByCourseId" resultType="com.ljp.xjt.dto.TeacherClassDto">
        SELECT DISTINCT
            cl.id AS classId,
            cl.class_name AS className
        FROM classes cl
        JOIN teaching_assignments ta ON cl.id = ta.class_id
        JOIN teachers t ON ta.teacher_id = t.id
        WHERE t.user_id = #{userId} AND ta.course_id = #{courseId}
    </select>

    <!-- 根据班级ID和课程ID，查询学生成绩列表 -->
    <select id="findGradesByClassAndCourse" resultType="com.ljp.xjt.dto.TeacherGradeDto">
        SELECT
            s.id AS studentId,
            s.student_name AS studentName,
            g.score,
            g.id AS gradeId
        FROM grades g
        JOIN students s ON g.student_id = s.id
        WHERE g.course_id = #{courseId}
          AND s.class_id = #{classId}
    </select>

</mapper> 